const GOOGLE_SCRIPT_URL=API_CONFIG.BASE_URL,page1=document.getElementById("page-1"),page2=document.getElementById("page-2"),nextBtn=document.getElementById("nextBtn"),clearsInput=document.getElementById("clears"),nameInput=document.getElementById("name"),errorMsg=document.getElementById("gate-error"),avoidanceContainer=document.getElementById("avoidance-container"),responses={meta:{},avoidances:{}};let validPlayerNames=[],validPlayerNamesLower=[];async function fetchValidPlayerNames(){try{const e=await fetch("data/players.json"),t=await e.json();validPlayerNames=[...new Set(t.data.map(e=>String(e[2]??"").trim()).filter(e=>""!==e))].sort(),validPlayerNamesLower=validPlayerNames.map(e=>e.toLowerCase()),setupNameAutocomplete()}catch(e){console.error("Failed to fetch player names",e)}}function validateGate(){const e=Number(clearsInput.value),t=nameInput.value.trim(),a=t.toLowerCase(),n=validPlayerNamesLower.includes(a);responses.meta.name=t,n&&e>=5?(nextBtn.disabled=!1,errorMsg.style.display="none"):(nextBtn.disabled=!0,!n&&t.length>0?(errorMsg.innerText="Name must match a valid AHoF player.",errorMsg.style.display="block"):e>0&&e<5?(errorMsg.innerText="You must have at least 5 AHoF clears.",errorMsg.style.display="block"):errorMsg.style.display="none")}fetchValidPlayerNames(),clearsInput.addEventListener("input",validateGate),nameInput.addEventListener("input",validateGate),nextBtn.addEventListener("click",()=>{page1.hidden=!0,page2.hidden=!1,document.getElementById("submitBtn").classList.remove("hidden")});const ratingCategories=[{key:"Reading Intricacy",label:"Reading Intricacy (RNG)"},{key:"Speed",label:"Speed (RNG)"},{key:"Density",label:"Density (RNG)"},{key:"Pattern",label:"Pattern (FIXED)"},{key:"Gimmick",label:"Gimmick"},{key:"Luck",label:"Luck"},{key:"Quality",label:"Quality"}];function createAvoidanceSection(e){responses.avoidances[e]={experience:null,ratings:{}};const t=document.createElement("div");t.className="avoidance";const a=avoidanceConfig.find(t=>t.name===e)?.color||"#ffffff",n=getContrastTextColor(a);t.style.backgroundColor=a,t.style.color=n,t.style.padding="20px",t.style.borderRadius="12px",t.style.marginBottom="24px",t.innerHTML=`\n\t  <h3>${e}</h3>\n\t\n\t  <p>\n\t    <strong>Do you have enough experience with this avoidance to rate it?</strong>\n\t  </p>\n\t\n\t  <div class="experience-buttons">\n\t    <button type="button" class="exp-btn" data-answer="yes">Yes</button>\n\t    <button type="button" class="exp-btn" data-answer="no">No</button>\n\t  </div>\n\t\n\t  <div class="ratings hidden">\n\t    <p class="rating-instructions">\n\t        Rate the game based on the following criteria.\n\t        (Refer to the <strong>"Category Information"</strong> sheet for rating definitions)\n\t    </p>\n\t  </div>\n\t`;const s=t.querySelector(".ratings"),i=t.querySelectorAll(".exp-btn");ratingCategories.forEach(({key:t,label:a})=>{const n=document.createElement("div");n.className="rating",n.dataset.categoryKey=t;const i=`${e}-${t}`.replace(/\s+/g,"_");n.innerHTML=`\n\t    <label class="rating-label">${a}</label>\n\t\n\t    <div class="rating-scale">\n\t      <div class="rating-numbers">\n\t        ${Array.from({length:11},(e,t)=>`<span>${t}</span>`).join("")}\n\t      </div>\n\t\n\t      <div class="rating-radios">\n\t        ${Array.from({length:11},(e,t)=>`\n\t          <label>\n\t            <input\n\t              type="radio"\n\t              name="${i}"\n\t              value="${t}"\n\t            />\n\t            <span class="radio-dot"></span>\n\t          </label>\n\t        `).join("")}\n\t      </div>\n\t    </div>\n\t  `,s.appendChild(n)}),i.forEach(t=>{t.addEventListener("click",()=>{const a=t.dataset.answer;if(i.forEach(e=>e.classList.remove("selected")),t.classList.add("selected"),"yes"===a)responses.avoidances[e].experience="yes",s.classList.remove("hidden"),submitBtn.classList.remove("hidden");else{responses.avoidances[e].experience="no",s.classList.add("hidden"),submitBtn.classList.add("hidden"),submitStatus.innerText="";s.querySelectorAll('input[type="radio"]').forEach(e=>{e.checked=!1,e.dataset.wasChecked="false"}),responses.avoidances[e].ratings={}}})}),s.addEventListener("click",t=>{if("radio"!==t.target.type)return;const a=t.target,n=a.closest(".rating").dataset.categoryKey,i=responses.avoidances[e];if("true"===a.dataset.wasChecked)a.checked=!1,a.dataset.wasChecked="false",delete i.ratings[n];else{s.querySelectorAll(`input[name="${a.name}"]`).forEach(e=>e.dataset.wasChecked="false"),a.dataset.wasChecked="true",i.ratings[n]=Number(a.value)}});const r=document.createElement("button");r.className="primary-button hidden",r.textContent="Submit";const o=document.createElement("p");return o.className="submit-status",t.appendChild(r),t.appendChild(o),r.addEventListener("click",async()=>{if(!function(){const t=responses.avoidances[e];return"yes"!==t.experience?(alert(`You must select "Yes" for "${e}" before submitting.`),!1):0!==Object.keys(t.ratings).length||(alert(`You must rate at least one category for "${e}".`),!1)}())return;r.disabled=!0,o.innerText="Submitting...";const t={meta:responses.meta,avoidances:{[e]:responses.avoidances[e]}};try{const e=await fetch(GOOGLE_SCRIPT_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if("ok"!==(await e.json()).status)throw new Error("Submission failed");o.innerText="Submitted successfully!"}catch(e){o.innerText="Submission failed. Please try again.",r.disabled=!1,console.error(e)}}),t}avoidanceConfig.forEach(({name:e})=>{avoidanceContainer.appendChild(createAvoidanceSection(e))});const submitBtn=document.getElementById("submitBtn"),submitStatus=document.getElementById("submitStatus");function validateBeforeSubmit(){let e=0;for(const[t,a]of Object.entries(responses.avoidances))if("yes"===a.experience){if(0===Object.keys(a.ratings).length)return alert(`You selected "Yes" for "${t}" but did not provide any ratings.`),!1;e++}return!(e<1)||(alert("You must rate at least 1 avoidance before submitting."),!1)}function setupNameAutocomplete(){const e=document.getElementById("name"),t=document.getElementById("name-autocomplete-list");e.addEventListener("input",()=>{const a=e.value.trim().toLowerCase();if(t.textContent="",!a)return t.classList.add("hidden"),void validateGate();const n=[],s=[];for(let e=0;e<validPlayerNames.length;e++){const t=validPlayerNames[e],i=validPlayerNamesLower[e];if(i.startsWith(a)?n.push(t):i.includes(a)&&s.push(t),n.length+s.length>=20)break}const i=[...n,...s].slice(0,10);if(0===i.length)return t.classList.add("hidden"),void validateGate();const r=document.createDocumentFragment();i.forEach(e=>{const t=document.createElement("div");t.className="autocomplete-item",t.dataset.value=e,t.textContent=e,r.appendChild(t)}),t.appendChild(r),t.classList.remove("hidden"),validateGate()}),t.addEventListener("click",a=>{const n=a.target.closest(".autocomplete-item");n&&(e.value=n.dataset.value,t.classList.add("hidden"),validateGate())}),document.addEventListener("click",e=>{e.target.closest(".autocomplete-wrapper")||t.classList.add("hidden")})}submitBtn.addEventListener("click",async()=>{if(validateBeforeSubmit()){submitBtn.disabled=!0,submitStatus.innerText="Submitting...";try{const e=await fetch(GOOGLE_SCRIPT_URL,{method:"POST",body:JSON.stringify(responses)});if("ok"!==(await e.json()).status)throw new Error("Submission failed");submitStatus.innerText="Submitted successfully. Thank you!"}catch(e){submitStatus.innerText="Submission failed. Please try again.",submitBtn.disabled=!1,console.error(e)}}});

const clearTable=document.getElementById("clear-table"),clearThead=clearTable.querySelector("thead"),clearTbody=clearTable.querySelector("tbody"),avoidanceColorMap=Object.fromEntries(avoidanceConfig.map(e=>[e.name,e.color])),avoidanceDifficultyMap=Object.fromEntries(avoidanceConfig.map((e,t)=>[e.name,t])),gameStyleMap={};Object.keys(avoidanceColorMap).forEach(e=>{const t=avoidanceColorMap[e];gameStyleMap[e]={backgroundColor:t,textColor:getContrastTextColor(t)}});const avatarToggle=document.getElementById("toggle-avatars");avatarToggle.addEventListener("change",()=>{clearTable.classList.toggle("hide-avatars",!avatarToggle.checked)});const GAME_VARIANTS={"I wanna HIVAC - Oblivion":{versions:["v1.0","v1.1"],defaultPreference:["v1.0","v1.1"],columnIndex:9},"I wanna be THE iDOLM@STER - Kotori Otonashi":{versions:["Very Hard","M@STER"],defaultPreference:["Very Hard","M@STER"],columnIndex:9},"I wanna grand of the perfect bear":{versions:["Normal","強化版"],defaultPreference:["Normal","強化版"],columnIndex:9},"I wanna kill the Kamilia 2 WARPED - Bottomless Abyss":{versions:["K2W","NPM"],defaultPreference:["K2W","NPM"],columnIndex:9}};let fullData=[],filteredData=[],headers=[],currentSort="date",currentOrder="desc",clearMode="all",exactMatchMode=!1,activeGameFilterFromUrl=null,autocompleteSources={games:[],players:[]};function buildAutocompleteSources(){const e=new Set,t=new Set;for(const a of fullData){const r=a[1],n=a[4];SecretManager.isSecretGame(r)||e.add(r),null!=n&&t.add(String(n))}autocompleteSources.games=Array.from(e).sort(),autocompleteSources.players=Array.from(t).sort()}function timeToSeconds(e){if(!e)return 0;if(e instanceof Date)return 3600*e.getHours()+60*e.getMinutes()+e.getSeconds();if("string"==typeof e){const t=e.split(":").map(Number);if(3===t.length)return 3600*t[0]+60*t[1]+t[2]}return 0}function sortData(){const e={date:0,game:1,country:2,player:4,death:5,time:6}[currentSort];filteredData.sort((t,a)=>{const r=t[e],n=a[e];if("date"===currentSort){const e=new Date(r),t=new Date(n);return"asc"===currentOrder?e-t:t-e}if("game"===currentSort){const e=avoidanceDifficultyMap[r],o=avoidanceDifficultyMap[n];return void 0===e&&void 0===o?new Date(t[0])-new Date(a[0]):void 0===e?1:void 0===o?-1:e!==o?"asc"===currentOrder?e-o:o-e:new Date(t[0])-new Date(a[0])}if("country"===currentSort){const e=!r?.trim(),t=!n?.trim();return e&&t?0:e?1:t?-1:"asc"===currentOrder?r.localeCompare(n):n.localeCompare(r)}if("player"===currentSort){const e=String(r??""),t=String(n??"");return"asc"===currentOrder?e.localeCompare(t):t.localeCompare(e)}if("death"===currentSort){const e=!r||"-"===r,t=!n||"-"===n;return e&&t?0:e?1:t?-1:"asc"===currentOrder?r-n:n-r}if("time"===currentSort){const e=!r||"-"===r,t=!n||"-"===n;if(e&&t)return 0;if(e)return 1;if(t)return-1;const a=timeToSeconds(r),o=timeToSeconds(n);return"asc"===currentOrder?a-o:o-a}})}function renderTable(){clearThead.textContent="",clearTbody.textContent="";const e=document.createDocumentFragment(),t={};filteredData.forEach(e=>{const a=e[1],r=e[0],n=e[8];if("M"===n||"T"===n)return;const o=r?new Date(r):null;o&&(!t[a]||o<t[a].date)&&(t[a]={row:e,date:o})});const a=document.createElement("tr"),r=document.createElement("th");r.textContent="#",a.appendChild(r),headers.forEach((e,t)=>{if(3===t||8===t||9===t)return;const r=document.createElement("th");r.textContent=e;let n=null;0===t&&(n="date"),1===t&&(n="game"),2===t&&(n="country"),4===t&&(n="player"),5===t&&(n="death"),6===t&&(n="time"),n&&(r.style.cursor="pointer",n===currentSort&&(r.textContent+="asc"===currentOrder?" ▲":" ▼"),r.onclick=()=>{currentSort===n?currentOrder="asc"===currentOrder?"desc":"asc":(currentSort=n,currentOrder="asc"),sortData(),renderTable()}),a.appendChild(r)}),clearThead.appendChild(a);let n=null,o=1;filteredData.forEach((a,r)=>{const l=document.createElement("tr"),c=a[1],d=a[8];if("game"===currentSort&&"all"===clearMode&&t[c]?.row===a&&l.classList.add("first-clear-row"),"game"===currentSort&&r>0){c!==filteredData[r-1][1]&&l.classList.add("game-divider")}let s;"game"===currentSort&&"all"===clearMode?(c!==n&&(o=1,n=c),s="M"===d?"M":"T"===d?"T":o++):s=r+1;const i=document.createElement("td");i.textContent=s,"M"===s?i.classList.add("maker-number"):"T"===s&&i.classList.add("tester-number"),l.appendChild(i);for(let e=0;e<a.length;e++){if(3===e||8===e||9===e)continue;const t=a[e],r=document.createElement("td");if([0,1,2,4].includes(e)&&(r.className="clickable-cell",r.dataset.filterIndex=e,r.dataset.value=t),0===e)if(t){const e=formatDateYYYYMMDD(t);r.textContent=e,r.dataset.value=e}else r.textContent="-";else if(1===e){const e=t,n=document.createElement("div");n.className="game-cell-wrapper";const o=document.createElement("span");o.textContent=e,o.className="ahof-game-link",n.appendChild(o);const l=GAME_VARIANTS[e];if(l){const e=a[l.columnIndex];if(e){const t=document.createElement("span");t.className="variant-badge",t.textContent="?",t.title=`${e}`,n.appendChild(t)}}r.appendChild(n);const c=SecretManager.getSecretStyle(t);if(c)r.style.backgroundColor=c.backgroundColor,r.style.color=getContrastTextColor(c.backgroundColor);else{const e=gameStyleMap[t];e&&(r.style.backgroundColor=e.backgroundColor,r.style.color=e.textColor)}}else if(2===e&&t){const e=document.createElement("span");e.className=`fi fi-${t.toLowerCase()} flag-icon`,r.appendChild(e)}else if(4===e){const e=document.createElement("div");e.className="player-cell";const n=document.createElement("img");n.className="avatar-img",n.loading="lazy",n.decoding="async",n.referrerPolicy="no-referrer",n.src=a[3]?"https://images.hsingh.app/?url="+a[3]+"&w=28&output=webp":"assets/images/default.webp",n.width="28",n.height="28",n.alt="Avatar",n.onerror=()=>n.src="assets/images/default.webp";const o=document.createElement("span");if(o.textContent=t,e.appendChild(n),e.appendChild(o),"M"===d||"T"===d){const t=document.createElement("span");t.className="role-badge "+("M"===d?"maker-badge":"tester-badge"),t.textContent=d,"PlasmaNapkin"===a[4]&&"I Wanna Wane"===a[1]&&"M"===d&&(t.dataset.secret="curveWAH",t.style.cursor="pointer"),e.appendChild(t)}r.appendChild(e)}else if(5===e||6===e)r.textContent=t||"-";else if(7===e&&t?.startsWith("http")){const e=document.createElement("a");e.href=t,e.textContent="Video",e.target="_blank",r.appendChild(e)}l.appendChild(r)}e.appendChild(l)}),clearTbody.appendChild(e),updateRowCount(),updateFilterSummary()}function applyFilter(){const e=document.getElementById("search-column").value,t=document.getElementById("search-input"),a=document.getElementById("country-select"),r=t.value.trim().toLowerCase();if(activeGameFilterFromUrl=null,filteredData=getBaseVisibleData(),"country"===e&&a.value)filteredData=filteredData.filter(e=>e[2]===a.value);else if("country"!==e&&r){const t={date:0,game:1,player:4}[e];filteredData=filteredData.filter(e=>{const a=e[t];if(null==a)return!1;let n;return n=0===t&&a?formatDateYYYYMMDD(a).toLowerCase():String(a??"").toLowerCase(),exactMatchMode?n===r:n.includes(r)})}filteredData=SecretManager.applySecrets(e,filteredData,fullData),filteredData=normalizeGameVariants(filteredData),updateVariantToggle(),applyClearMode(),sortData(),renderTable()}function getBaseVisibleData(){return fullData.filter(e=>!SecretManager.isSecretGame(e[1]))}function populateCountryDropdown(){const e=document.getElementById("country-select"),t=[...new Set(fullData.map(e=>e[2]))].filter(Boolean).sort();e.innerHTML="<option value=''>Select country</option>",t.forEach(t=>{const a=document.createElement("option");a.value=t,a.textContent=formatCountryDisplay(t),e.appendChild(a)})}function applyClearMode(){if("all"===clearMode)return;const e={};filteredData.forEach(t=>{const a=t[1],r=new Date(t[0]),n=t[8],o="M"===n||"T"===n;if(!e[a])return void("first"===clearMode&&o||(e[a]=t));const l=new Date(e[a][0]);"first"===clearMode?!o&&r<l&&(e[a]=t):"latest"===clearMode&&r>l&&(e[a]=t)}),filteredData=Object.values(e)}function updateRowCount(){const e=document.getElementById("row-count");if(!e)return;const t=filteredData.length;e.textContent=`Showing ${t} Clear${1===t?"":"s"}`}function updateFilterSummary(){const e=document.getElementById("filter-summary"),t=document.getElementById("search-column"),a=document.getElementById("search-input"),r=document.getElementById("country-select"),n=[];"first"===clearMode?n.push("First Clears"):"latest"===clearMode?n.push("Latest Clears"):n.push("All Clears");const o=t.value;"player"===o&&""!==a.value.trim()&&n.push(`Player = ${a.value.trim()}`),"game"===o&&""!==a.value.trim()&&n.push(`Game = ${a.value.trim()}`),activeGameFilterFromUrl&&n.push(`Game = ${activeGameFilterFromUrl}`),"country"===o&&r.value&&n.push(`Country = ${formatCountryDisplay(r.value)}`),e.textContent=`Showing: ${n.join(" | ")}`}function updateSearchPlaceholder(){const e=document.getElementById("search-column"),t=document.getElementById("search-input"),a=e.options[e.selectedIndex].text;t.placeholder=`Search ${a}...`}function setupSearch(){const e=document.getElementById("search-input"),t=document.getElementById("search-column"),a=document.getElementById("country-select"),r=document.getElementById("clear-search");updateSearchPlaceholder(),document.querySelectorAll('input[name="clear-mode"]').forEach(e=>{e.addEventListener("change",e=>{clearMode=e.target.value,applyFilter()})}),e.addEventListener("input",()=>{exactMatchMode=!1,applyFilter()}),a.addEventListener("change",()=>{exactMatchMode=!1,applyFilter()}),t.addEventListener("change",()=>{e.value="",a.value="","country"===t.value?(e.classList.add("hidden"),a.classList.remove("hidden")):(a.classList.add("hidden"),e.classList.remove("hidden"),updateSearchPlaceholder()),applyFilter()}),r.addEventListener("click",()=>{e.value="",a.value="",t.value="game",exactMatchMode=!1,a.classList.add("hidden"),e.classList.remove("hidden"),updateSearchPlaceholder(),SecretManager.resetSecrets(),applyFilter()})}function setupAutocomplete(){const e=document.getElementById("search-input"),t=document.getElementById("autocomplete-list"),a=document.getElementById("search-column");e.addEventListener("input",()=>{const r=e.value.trim().toLowerCase(),n=a.value;if(t.textContent="",!r)return void t.classList.add("hidden");let o;if("game"===n)o=autocompleteSources.games;else{if("player"!==n)return void t.classList.add("hidden");o=autocompleteSources.players}const l=[],c=[];for(const e of o){if(null==e)continue;const t=String(e).toLowerCase();if(t.startsWith(r)?l.push(e):t.includes(r)&&c.push(e),l.length+c.length>=20)break}const d=[...l,...c].slice(0,10);if(0===d.length)return void t.classList.add("hidden");const s=document.createDocumentFragment();d.forEach(e=>{const t=document.createElement("div");t.className="autocomplete-item",t.dataset.value=e,t.textContent=e,s.appendChild(t)}),t.appendChild(s),t.classList.remove("hidden")}),t.addEventListener("click",a=>{const r=a.target.closest(".autocomplete-item");r&&(e.value=r.dataset.value,exactMatchMode=!0,t.classList.add("hidden"),applyFilter())}),document.addEventListener("click",e=>{e.target.closest(".autocomplete-wrapper")||t.classList.add("hidden")})}function applyUrlFilters(){const e=new URLSearchParams(window.location.search),t=e.get("player"),a=e.get("game");if(!t&&!a)return;const r=document.getElementById("search-column"),n=document.getElementById("search-input"),o=document.getElementById("country-select");if(t)return r.value="player",n.classList.remove("hidden"),o.classList.add("hidden"),n.value=t,exactMatchMode=!0,updateSearchPlaceholder(),applyFilter(),void(a&&(activeGameFilterFromUrl=a,filteredData=filteredData.filter(e=>e[1]===a),renderTable()));a&&(r.value="game",n.classList.remove("hidden"),o.classList.add("hidden"),n.value=a,exactMatchMode=!0,updateSearchPlaceholder(),applyFilter())}function applyExactFilter(e,t){const a=document.getElementById("search-column"),r=document.getElementById("search-input"),n=document.getElementById("country-select"),o={0:"date",1:"game",2:"country",4:"player"}[e];o&&(a.value=o,updateSearchPlaceholder(),"country"===o?(r.classList.add("hidden"),n.classList.remove("hidden"),n.value=t):(n.classList.add("hidden"),r.classList.remove("hidden"),r.value=t),exactMatchMode=!0,applyFilter(),window.scrollTo({top:0,behavior:"smooth"}))}function formatDateYYYYMMDD(e){const t=new Date(e);return`${t.getUTCFullYear()}-${String(t.getUTCMonth()+1).padStart(2,"0")}-${String(t.getUTCDate()).padStart(2,"0")}`}function normalizeGameVariants(e){const t=[],a={},r=document.querySelector('input[name="variant-toggle"]:checked')?.value;return e.forEach(e=>{const r=e[1];if(!GAME_VARIANTS[r])return void t.push(e);const n=e[GAME_VARIANTS[r].columnIndex],o=e[4];a[r]||(a[r]={}),a[r][o]||(a[r][o]={}),a[r][o][n]=e}),Object.entries(a).forEach(([e,a])=>{const n=GAME_VARIANTS[e];Object.values(a).forEach(e=>{if(r)return void(e[r]&&t.push(e[r]));for(const a of n.defaultPreference)if(e[a])return void t.push(e[a]);const a=Object.values(e)[0];a&&t.push(a)})}),t}function updateVariantToggle(){const e=document.getElementById("variant-toggle-container"),t=document.getElementById("search-column").value,a=document.getElementById("search-input").value;if("game"!==t||!GAME_VARIANTS[a])return e.classList.add("hidden"),void(e.innerHTML="");const r=GAME_VARIANTS[a],n=document.querySelector('input[name="variant-toggle"]:checked')?.value,o=n&&r.versions.includes(n)?n:r.versions[0];e.innerHTML=r.versions.map(e=>`\n    <label>\n      <input type="radio"\n        name="variant-toggle"\n        value="${e}"\n        ${e===o?"checked":""}>\n        ${e}\n    </label>\n  `).join(""),e.classList.remove("hidden"),e.querySelectorAll("input").forEach(e=>{e.addEventListener("change",applyFilter)})}fetch("data/clear-list.json").then(e=>e.json()).then(e=>{headers=e.headers,fullData=e.data,filteredData=getBaseVisibleData(),buildAutocompleteSources(),populateCountryDropdown(),setupSearch(),setupAutocomplete(),applyUrlFilters(),sortData(),renderTable(),document.getElementById("loader").classList.add("hidden"),clearTable.classList.remove("hidden"),SecretManager.init({applyFilter:applyFilter,getSearchState:()=>({column:document.getElementById("search-column").value,input:document.getElementById("search-input").value.trim()}),getColumnSelect:()=>document.getElementById("search-column")})}).catch(e=>{console.error(e),document.getElementById("loader").innerHTML="<p style='color:red;'>Failed to load data.</p>"}),clearTbody.addEventListener("click",e=>{const t=e.target.closest(".role-badge");if("curveWAH"===t?.dataset.secret)return e.stopPropagation(),void SecretManager.toggleCurveWAH();const a=e.target.closest(".clickable-cell");if(!a?.dataset.filterIndex)return;const r=parseInt(a.dataset.filterIndex),n=a.dataset.value,o={0:"date",1:"game",2:"country",4:"player"}[r];"game"===o&&SecretManager.isSecretGame(n)||("player"===o&&SecretManager.isSecretModeActive()&&SecretManager.resetSecrets(),applyExactFilter(r,n))}),clearTbody.addEventListener("mouseover",e=>{const t=e.target.closest(".role-badge");t&&SecretManager.handlePlasmaHover(t,!0)}),clearTbody.addEventListener("mouseout",e=>{const t=e.target.closest(".role-badge");t&&SecretManager.handlePlasmaHover(t,!1)});

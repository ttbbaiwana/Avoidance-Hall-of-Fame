<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Clear List</title>
  <link rel="stylesheet" href="assets/css/styles.css">
</head>

<body>

<div id="header-placeholder"></div>

<div class="page-content">
  <h1>Clear List</h1>

  <div id="loader" class="loader">
    <div class="spinner"></div>
    <p>Loading clear list...</p>
  </div>
	
	<div class="pagination" id="pagination-top"></div>
	<br/>
	
  <div class="table-wrapper">
    <table id="clear-table" class="ahof-table hidden">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

<div class="pagination" id="pagination-bottom"></div>
<br/>

</div>

<script src="assets/js/config.js"></script>
<script src="assets/js/layout.js"></script>

<script>
	const pageCache = {};
	const API_URL = "https://script.google.com/macros/s/AKfycbwNjbI5YyD4jA4_sFj6IqZ4uyVOJ7U2b31dIaqOH7rNkvs8hhB5BF4ZOxVcxFjkjcCr/exec";
	const PAGE_SIZE = 100;
	const PAGE_WINDOW = 5;
	
	let currentPage = 1;
	let totalRows = 0;
	let totalPages = 1;
	
	function renderTable(headers, data) {
	  const thead = document.querySelector("#clear-table thead");
	  const tbody = document.querySelector("#clear-table tbody");
	
	  thead.innerHTML = "";
	  tbody.innerHTML = "";
	
	  const headerRow = document.createElement("tr");
	  headers.forEach(h => {
	    const th = document.createElement("th");
	    th.textContent = h;
	    headerRow.appendChild(th);
	  });
	  thead.appendChild(headerRow);
	
	  data.forEach(row => {
	    const tr = document.createElement("tr");
	
	    row.forEach((cell, index) => {
	      const td = document.createElement("td");
	      
	      // DATE
				if (index === 0) {
					td.textContent = cell;
				}
			
				// DEATH
				else if (index === 3) {
					td.textContent = cell ? cell : "-";
				}
				
				// TIME
				else if (index === 4) {
					td.textContent = cell ? cell.replace(".000", "") : "-";
				}
	
	      // VIDEO LINK
	      else if (index === 5 && typeof cell === "string" && cell.startsWith("http")) {
	        const a = document.createElement("a");
	        a.href = cell;
	        a.textContent = "Video";
	        a.target = "_blank";
	        td.appendChild(a);
	      }
	
	      else {
	        td.textContent = cell;
	      }
	
	      tr.appendChild(td);
	    });
	
	    tbody.appendChild(tr);
	  });
	}
	
	function loadPage(page) {

	  if (totalPages > 1) {
	    page = Math.max(1, Math.min(page, totalPages));
	  }
	
	  document.getElementById("loader").classList.remove("hidden");
	  document.getElementById("clear-table").classList.add("hidden");
	
	  if (pageCache[page]) {
	    renderTable(pageCache[page].headers, pageCache[page].data);
	
	    currentPage = page;
	    renderPagination();
	
	    document.getElementById("loader").classList.add("hidden");
	    document.getElementById("clear-table").classList.remove("hidden");
	
	    return;
	  }
	
	  fetch(`${API_URL}?page=${page}&pageSize=${PAGE_SIZE}`)
	    .then(res => res.json())
	    .then(json => {
	
	      pageCache[page] = json;
	
	      totalRows = json.total;
	      totalPages = Math.ceil(totalRows / PAGE_SIZE);
	
	      currentPage = page;
	
	      renderTable(json.headers, json.data);
	      renderPagination();
	
	      document.getElementById("loader").classList.add("hidden");
	      document.getElementById("clear-table").classList.remove("hidden");
				
	      if (totalPages > 1) {
	        prefetchPage(page + 1);
	        prefetchPage(page - 1);
	      }
	    });
	}

	function prefetchPage(page) {
	  if (page < 1 || page > totalPages) return;
	  if (pageCache[page]) return;
	
	  fetch(`${API_URL}?page=${page}&pageSize=${PAGE_SIZE}`)
	    .then(res => res.json())
	    .then(json => {
	      pageCache[page] = json;
	    });
	}
	
	function renderPagination() {
    renderPaginationInto("pagination-top");
    renderPaginationInto("pagination-bottom");
  }
  
  function renderPaginationInto(containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = "";
  
    addButton(container, "First", () => loadPage(1), currentPage === 1);
    addButton(container, "<<", () => loadPage(currentPage - 10), currentPage <= 10);
  
    const start = Math.max(1, currentPage - PAGE_WINDOW);
    const end = Math.min(totalPages, currentPage + PAGE_WINDOW);
  
    for (let i = start; i <= end; i++) {
      const isCurrent = i === currentPage;
      addButton(container, i, () => loadPage(i), false, isCurrent);
    }
  
    addButton(container, ">>", () => loadPage(currentPage + 10), currentPage + 10 > totalPages);
    addButton(container, "Last", () => loadPage(totalPages), currentPage === totalPages);
  }
  
  function addButton(container, label, onClick, disabled = false, active = false) {
    const btn = document.createElement("button");
    btn.textContent = label;
  
    if (active) {
      btn.classList.add("active-page");
    }
  
    btn.disabled = disabled;
    btn.onclick = onClick;
  
    container.appendChild(btn);
  }
	
	loadPage(1);
</script>

</body>
</html>

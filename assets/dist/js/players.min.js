let playersFullData=[],playersFilteredData=[],playersNameIndex=[],playersExactMatchMode=!1;function renderPlayers(e){const t=document.getElementById("players-grid");t.innerHTML="",e.forEach(e=>{const a=e[0],l=e[1]?"https://images.hsingh.app/?url="+e[1]+"&w=48&output=webp":"assets/images/default.webp",n=e[2],s=e.slice(3,7).filter(Boolean),r=e[7],o=document.createElement("div");o.classList.add("player-card");const c=document.createElement("div");c.classList.add("player-card-header");const d=document.createElement("img");d.classList.add("player-avatar"),d.loading="lazy",d.referrerPolicy="no-referrer",d.src=l||"assets/images/default.webp",d.width="48",d.height="48",d.alt="Avatar",d.onerror=()=>d.src="assets/images/default.webp";const i=document.createElement("span");i.classList.add("fi",`fi-${a.toLowerCase()}`),i.classList.add("flag-icon","clickable-flag"),i.addEventListener("click",()=>{const e=document.getElementById("players-search-column"),t=document.getElementById("players-country-select"),l=document.getElementById("players-search-input");e.value="country",l.classList.add("hidden"),t.classList.remove("hidden"),t.value=a,playersExactMatchMode=!0,applyPlayersFilter(),window.scrollTo({top:0,behavior:"smooth"})});const p=document.createElement("h3");p.textContent=n,p.classList.add("clickable-player"),p.addEventListener("click",()=>{const e=encodeURIComponent(n);window.location.href=`clears.html?player=${e}`}),c.appendChild(d),c.appendChild(i),c.appendChild(p),o.appendChild(c);const u=document.createElement("div");u.classList.add("player-links"),[...s,r].filter(Boolean).forEach(e=>{const t=document.createElement("a");t.href=e,t.target="_blank";const a=getPlatformInfo(e);if(a.key&&PLATFORM_ICONS[a.key]){const e=document.createElement("img");e.src=`assets/images/icons/${PLATFORM_ICONS[a.key]}`,e.alt="",e.classList.add("platform-icon"),t.appendChild(e)}const l=document.createElement("span");l.textContent=a.name,t.appendChild(l),u.appendChild(t)}),o.appendChild(u),t.appendChild(o)}),updatePlayersCount(),updatePlayersFilterSummary()}function getPlatformInfo(e){const t=e.toLowerCase();return t.includes("youtube.com")?{name:"YouTube",key:"youtube"}:t.includes("twitch.tv")?{name:"Twitch",key:"twitch"}:t.includes("nicovideo.jp")?{name:"NicoNico",key:"nicovideo"}:t.includes("bilibili.com")?{name:"Bilibili",key:"bilibili"}:t.includes("naver.com")?{name:"Naver",key:"naver"}:t.includes("sooplive.co.kr")?{name:"SOOP",key:"soop"}:t.includes("twitter.com")?{name:"Twitter",key:"twitter"}:t.includes("bsky.app")?{name:"BlueSky",key:"bsky"}:{name:"Link",key:null}}function setupPlayersSearch(){const e=document.getElementById("players-search-column"),t=document.getElementById("players-search-input"),a=document.getElementById("players-country-select"),l=document.getElementById("players-clear-search");updatePlayersPlaceholder(),e.addEventListener("change",()=>{playersExactMatchMode=!1,t.value="",a.value="","country"===e.value?(t.classList.add("hidden"),a.classList.remove("hidden")):(a.classList.add("hidden"),t.classList.remove("hidden")),updatePlayersPlaceholder(),applyPlayersFilter()}),t.addEventListener("input",()=>{playersExactMatchMode=!1,applyPlayersFilter()}),a.addEventListener("change",()=>{playersExactMatchMode=!1,applyPlayersFilter()}),l.addEventListener("click",()=>{t.value="",a.value="",playersExactMatchMode=!1,updatePlayersPlaceholder(),applyPlayersFilter()})}function applyPlayersFilter(){const e=document.getElementById("players-search-column").value,t=document.getElementById("players-search-input"),a=document.getElementById("players-country-select"),l=t.value.trim().toLowerCase();playersFilteredData=[...playersFullData],"country"===e&&a.value?playersFilteredData=playersFilteredData.filter(e=>e[0]===a.value):"player"===e&&l&&(playersFilteredData=playersFilteredData.filter(e=>{const t=String(e[2]??"").toLowerCase();return playersExactMatchMode?t===l:t.includes(l)})),renderPlayers(playersFilteredData)}function setupPlayersAutocomplete(){const e=document.getElementById("players-search-input"),t=document.getElementById("players-autocomplete-list");e.addEventListener("input",()=>{const a=e.value.trim().toLowerCase();if(t.textContent="",!a)return void t.classList.add("hidden");const l=playersNameIndex,n=[],s=[];for(const e of l){const t=e.toLowerCase();if(t.startsWith(a)?n.push(e):t.includes(a)&&s.push(e),n.length+s.length>=20)break}const r=[...n,...s].slice(0,10);if(!r.length)return void t.classList.add("hidden");const o=document.createDocumentFragment();r.forEach(e=>{const t=document.createElement("div");t.className="autocomplete-item",t.dataset.value=e,t.textContent=e,o.appendChild(t)}),t.appendChild(o),t.classList.remove("hidden")}),t.addEventListener("click",a=>{const l=a.target.closest(".autocomplete-item");l&&(e.value=l.dataset.value,playersExactMatchMode=!0,t.classList.add("hidden"),applyPlayersFilter())}),document.addEventListener("click",e=>{e.target.closest(".autocomplete-wrapper")||t.classList.add("hidden")})}function updatePlayersPlaceholder(){const e=document.getElementById("players-search-column");document.getElementById("players-search-input").placeholder=`Search ${e.options[e.selectedIndex].text}...`}function populateCountryDropdown(){const e=document.getElementById("players-country-select"),t=[...new Set(playersFullData.map(e=>e[0]))].filter(Boolean).sort();e.innerHTML="<option value=''>Select country</option>",t.forEach(t=>{const a=document.createElement("option");a.value=t,a.textContent=formatCountryDisplay(t),e.appendChild(a)})}function updatePlayersCount(){document.getElementById("players-count").textContent=`Showing ${playersFilteredData.length} players`}function updatePlayersFilterSummary(){const e=document.getElementById("players-search-column").value,t=document.getElementById("players-search-input"),a=document.getElementById("players-country-select");let l="Showing: All Players";"country"===e&&a.value?l=`Showing: Country = ${formatCountryDisplay(a.value)}`:t.value.trim()&&(l=`Showing: Player = ${t.value.trim()}`),document.getElementById("players-filter-summary").textContent=l}fetch("data/players.json").then(e=>e.json()).then(e=>{playersFullData=e.data,playersFilteredData=[...playersFullData],playersNameIndex=[...new Set(playersFullData.map(e=>String(e[2]??"").trim()).filter(Boolean))].sort(),populateCountryDropdown(),setupPlayersSearch(),setupPlayersAutocomplete(),renderPlayers(playersFilteredData),document.getElementById("players-loader").classList.add("hidden"),document.getElementById("players-content").classList.remove("hidden")}).catch(e=>{console.error(e),document.getElementById("players-loader").innerHTML="<p style='color:red;'>Failed to load players.</p>"});
